var B=Object.defineProperty;var T=(r,t,e)=>t in r?B(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var n=(r,t,e)=>T(r,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const h of o.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const v=20,w=10,m=5,u=2;function C(){const r=document.getElementById("gameGUI");r.style.gridTemplateColumns=`repeat(${w}, 1fr)`,r.style.gridTemplateRows=`repeat(${v}, 1fr)`,document.createElement("div").classList.add("cell"),[...new Array(v*w)].map(e=>{const s=document.createElement("div");s.classList.add("cell"),r==null||r.appendChild(s)})}function y(r){const t=document.getElementById("gameBackground");[...new Array(r)].map(e=>{const s=document.createElement("div");s.classList.add("star"),s.style.left=`${Math.random()*100}%`,s.style.top=`${Math.random()*100}%`,s.style.animationDelay=`${Math.random()*2}s`,t==null||t.appendChild(s)})}const p=class p{static getOscillator(t){var i,o,h;const e=(i=this.audioCtx)==null?void 0:i.createOscillator(),s=(o=this.audioCtx)==null?void 0:o.createGain();return e&&((h=this.audioCtx)!=null&&h.destination)&&s&&(e.type="square",e.frequency.setValueAtTime(t,this.audioCtx.currentTime||0),e.connect(s),s.connect(this.audioCtx.destination),s.gain.setValueAtTime(.05,this.audioCtx.currentTime)),e}static beep(t){const e=this.getOscillator(t);e&&(e.start(),setTimeout(()=>{e.stop()},100))}static beepMove(){[...new Array(1)].forEach(()=>{this.beep(210)})}static beepDrop(){[...new Array(1)].forEach(()=>{this.beep(310)})}static beepDeny(){[...new Array(3)].forEach(()=>{this.beep(105)})}static beepClearRow(t){setTimeout(()=>{[...new Array(3)].forEach(()=>{this.beep(400+50*t)})},0+100*t)}};n(p,"AudioContext",typeof window<"u"&&window.AudioContext||null),n(p,"audioCtx",p.AudioContext?new p.AudioContext:null);let c=p;class l{static detectCollisionOnLeft(t,e){const{mapCopy:s,tetrisBlockCopy:i}=this.getDeepCopy(t,e);s.eraseBlock(i),i.moveLeft();const o=i.getCells();return this.checkCollision(o,s)}static detectCollisionOnRight(t,e){const{mapCopy:s,tetrisBlockCopy:i}=this.getDeepCopy(t,e);s.eraseBlock(e),i.moveRight();const o=i.getCells();return this.checkCollision(o,s)}static detectCollisionOnBottom(t,e){const{mapCopy:s,tetrisBlockCopy:i}=this.getDeepCopy(t,e);s.eraseBlock(e),i.moveDown();const o=i.getCells();return this.checkCollision(o,s)}static detectCollisionOnRotation(t,e){const{mapCopy:s,tetrisBlockCopy:i}=this.getDeepCopy(t,e);s.eraseBlock(e),i.rotate();const o=i.getCells();return this.checkCollision(o,s)}static detectCollisionOnStart(t,e){return this.checkCollision(e.getCells(),t)}static getDeepCopy(t,e){const s=t.getDeepCopy(),i=e.getDeepCopy();return{mapCopy:s,tetrisBlockCopy:i}}static checkCollision(t,e){let s=!1;return t.forEach(i=>{s||e.isEmptyCell(i)||(s=!0)}),s}}class D{constructor(t){n(this,"service");this.service=t,this.handleKeyDown=this.handleKeyDown.bind(this),document.addEventListener("keydown",this.handleKeyDown)}handleKeyDown(t){if(!t.defaultPrevented)switch(t.key){case"ArrowLeft":this.service.moveBlockLeft();break;case"ArrowRight":this.service.moveBlockRight();break;case"ArrowDown":this.service.moveBlockDown();break;case"ArrowUp":this.service.rotateBlock();break;case" ":this.service.dropBlock();break}}}class f{constructor(){n(this,"service");n(this,"controller");n(this,"round",1);n(this,"roundSkipCount",0);n(this,"startTime");n(this,"timer");n(this,"score",0);this.serviceCallback=this.serviceCallback.bind(this),this.timer=new L}serviceCallback({score:t,isWin:e}){if(e){for(this.roundSkipCount=0,this.round++,this.roundSkipCount++,this.score=t;this.score>this.getWinScore();)this.round++,this.roundSkipCount++,a.writeRound(this.round);a.writeRound(this.round),this.nextRound();return}this.timer.clearDrawTimeInterval(),S()}start(){this.nextRound(),a.writeRound(this.round)}nextRound(){var t;this.setNextRound(),(t=this.service)!=null&&t.grid&&a.draw(this.service.grid),E(this.round,this.roundSkipCount),setTimeout(()=>{this.startTime||(this.startTime=Date.now(),this.timer.start()),O(),this.service&&this.service.start()},2e3)}setNextRound(){this.service=new b(new k,this.getWinScore(),this.score,this.getDropDownIntervalTime(),this.serviceCallback),this.controller=new D(this.service)}getDropDownIntervalTime(){const t=1e3-100*this.round;return Math.max(t,400)}getWinScore(){return 1500+this.round*this.round*200}}class k{constructor(t){n(this,"rowCounts",v);n(this,"columnCounts",w);n(this,"grid",[]);t?this.grid=t:this.grid=this.createEmptyGrid()}getGrid(){return this.grid}createEmptyGrid(){const t=[];for(let e=0;e<this.rowCounts;e++){const s=[];for(let i=0;i<this.columnCounts;i++)s.push(0);t.push(s)}return t}eraseBlock(t){const e=t.shape.length,s=t.shape[0].length;for(let i=0;i<e;i++)for(let o=0;o<s;o++)t.shape[i][o]!==0&&(t.position.x-1+o<0||t.position.x-1+o>this.grid[0].length-1||t.position.y-1+i<0||t.position.y-1+i>this.grid.length-1||(this.grid[t.position.y-1+i][t.position.x-1+o]=0))}drawBlock(t){const e=t.shape.length,s=t.shape[0].length;for(let i=0;i<e;i++)for(let o=0;o<s;o++)t.shape[i][o]!==0&&(t.position.x-1+o<0||t.position.x-1+o>this.grid[0].length-1||t.position.y-1+i<0||t.position.y-1+i>this.grid.length-1||(this.grid[t.position.y-1+i][t.position.x-1+o]=t.shape[i][o]))}clearRow(){let t=0;for(let e=this.grid.length-1;e>0;e--){let s=0;if(!this.grid[e].includes(0))for(;!this.grid[e].includes(0);){s++,c.beepClearRow(s);for(let i=e-1;i>=0;i--)this.grid[i+1]=this.grid[i];this.grid[0]=new Array(this.grid[0].length).fill(0)}t+=1e3*s*s}return t}isEmptyCell({x:t,y:e}){return!(t<0||t>this.grid[0].length-1||e<0||e>this.grid.length-1||this.grid[e][t]!==0)}printGrid(){console.log(JSON.parse(JSON.stringify(this.grid)))}getDeepCopy(){const t=this.grid.map(e=>[...e]);return new k(t)}}class b{constructor(t,e,s,i,o){n(this,"grid");n(this,"tetrisBlocks");n(this,"movingTetrisBlock");n(this,"drawInterval");n(this,"fallingDownInterval");n(this,"isHitBottom",!1);n(this,"dropDownIntervalTime");n(this,"isStart",!1);n(this,"winScore");n(this,"score");n(this,"callback");this.grid=t,this.winScore=e,this.score=s,this.movingTetrisBlock=this.getNewTetrisBlock(),this.tetrisBlocks=[...new Array(3)].map(h=>this.getNewTetrisBlock()),a.drawPreview(this.tetrisBlocks[0]),this.grid.drawBlock(this.movingTetrisBlock),this.dropDownIntervalTime=i,this.callback=o}start(){this.isStart=!0,this.startDrawInterval(),this.fallingDownInterval=this.getFallingDownInterval(),a.drawPreview(this.tetrisBlocks[0])}dropBlock(){if(this.isStart){for(c.beepDrop();!l.detectCollisionOnBottom(this.grid,this.movingTetrisBlock);)this.grid.eraseBlock(this.movingTetrisBlock),this.movingTetrisBlock.moveDown(),this.grid.drawBlock(this.movingTetrisBlock),a.draw(this.grid);this.next()}}moveBlockLeft(){if(this.isStart){if(l.detectCollisionOnLeft(this.grid,this.movingTetrisBlock)){c.beepDeny();return}c.beepMove(),this.grid.eraseBlock(this.movingTetrisBlock),this.movingTetrisBlock.moveLeft(),this.grid.drawBlock(this.movingTetrisBlock)}}moveBlockRight(){if(this.isStart){if(l.detectCollisionOnRight(this.grid,this.movingTetrisBlock)){c.beepDeny();return}c.beepMove(),this.grid.eraseBlock(this.movingTetrisBlock),this.movingTetrisBlock.moveRight(),this.grid.drawBlock(this.movingTetrisBlock)}}moveBlockDown(){if(this.isStart){if(l.detectCollisionOnBottom(this.grid,this.movingTetrisBlock)){c.beepDeny();return}c.beepMove(),this.grid.eraseBlock(this.movingTetrisBlock),this.movingTetrisBlock.moveDown(),this.grid.drawBlock(this.movingTetrisBlock)}}rotateBlock(){if(!this.isStart)return;if(this.grid.eraseBlock(this.movingTetrisBlock),c.beepMove(),!l.detectCollisionOnRotation(this.grid,this.movingTetrisBlock)){this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}let t=this.movingTetrisBlock.getDeepCopy();if(t.moveRight(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveRight(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}if(t=this.movingTetrisBlock.getDeepCopy(),t.moveLeft(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveLeft(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}if(t=this.movingTetrisBlock.getDeepCopy(),t.moveRight(),t.moveRight(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveRight(),this.movingTetrisBlock.moveRight(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}if(t=this.movingTetrisBlock.getDeepCopy(),t.moveLeft(),t.moveLeft(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveLeft(),this.movingTetrisBlock.moveLeft(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}if(t=this.movingTetrisBlock.getDeepCopy(),t.moveDown(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveDown(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}if(t=this.movingTetrisBlock.getDeepCopy(),t.moveDown(),t.moveLeft(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveDown(),this.movingTetrisBlock.moveLeft(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}if(t=this.movingTetrisBlock.getDeepCopy(),t.moveDown(),t.moveRight(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveDown(),this.movingTetrisBlock.moveRight(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}if(t=this.movingTetrisBlock.getDeepCopy(),t.moveDown(),t.moveLeft(),t.moveLeft(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveDown(),this.movingTetrisBlock.moveLeft(),this.movingTetrisBlock.moveLeft(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}if(t=this.movingTetrisBlock.getDeepCopy(),t.moveDown(),t.moveRight(),t.moveRight(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveDown(),this.movingTetrisBlock.moveRight(),this.movingTetrisBlock.moveRight(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}if(t=this.movingTetrisBlock.getDeepCopy(),t.moveDown(),t.moveDown(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveDown(),this.movingTetrisBlock.moveDown(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}if(t=this.movingTetrisBlock.getDeepCopy(),t.moveDown(),t.moveDown(),t.moveLeft(),t.rotate(),!l.checkCollision(t.getCells(),this.grid)){this.movingTetrisBlock.moveDown(),this.movingTetrisBlock.moveDown(),this.movingTetrisBlock.moveLeft(),this.movingTetrisBlock.rotate(),this.grid.drawBlock(this.movingTetrisBlock);return}this.grid.drawBlock(this.movingTetrisBlock),c.beepDeny()}getFallingDownInterval(){return setInterval(()=>{if(l.detectCollisionOnBottom(this.grid,this.movingTetrisBlock)||(this.grid.eraseBlock(this.movingTetrisBlock),this.movingTetrisBlock.moveDown(),this.grid.drawBlock(this.movingTetrisBlock)),l.detectCollisionOnBottom(this.grid,this.movingTetrisBlock)){this.isHitBottom&&this.next(),this.isHitBottom=!0;return}this.isHitBottom=!1},this.dropDownIntervalTime)}next(){if(this.isStart=!1,this.score+=5,this.clearFallingDownInterval(),this.score+=this.grid.clearRow(),a.draw(this.grid),a.writeScore(this.score),console.log(this.score,this.winScore),this.score>=this.winScore){console.log("win!"),this.win();return}if(this.setNextBlock(),l.detectCollisionOnStart(this.grid,this.movingTetrisBlock)){console.log("lose!"),this.lose();return}this.grid.drawBlock(this.movingTetrisBlock),this.fallingDownInterval=this.getFallingDownInterval(),this.isStart=!0}getNewTetrisBlock(){return I.getNewBlock()}startDrawInterval(){this.drawInterval=setInterval(()=>{a.draw(this.grid)},16)}clearDrawInterval(){clearInterval(this.drawInterval)}clearFallingDownInterval(){this.isHitBottom=!1,clearInterval(this.fallingDownInterval)}setNextBlock(){const t=this.tetrisBlocks.shift();if(!t)throw Error("there is no next block");a.drawPreview(this.tetrisBlocks[0]),this.tetrisBlocks.push(this.getNewTetrisBlock()),this.movingTetrisBlock=t}lose(){this.clearDrawInterval(),this.clearFallingDownInterval(),this.isStart=!1,this.callback({score:this.score,isWin:!1})}win(){this.clearDrawInterval(),this.clearFallingDownInterval(),this.isStart=!1,this.callback({score:this.score,isWin:!0})}}class d{constructor(t,e){n(this,"shape");n(this,"position");if(t.length!==t[0].length)throw Error("only sqaure matrix");this.shape=t,this.position=e}getDeepCopy(){const t=this.shape.map(s=>[...s]),e={...this.position};return new d(t,e)}getCells(){const t=[];for(let e=0;e<this.shape.length;e++)for(let s=0;s<this.shape[0].length;s++)this.shape[e][s]!==0&&t.push({x:this.position.x-1+s,y:this.position.y-1+e});return t}rotate(){const t=[];for(let e=0;e<this.shape.length;e++){const s=[];for(let i=this.shape[0].length-1;i>=0;i--)s.push(this.shape[i][e]);t.push(s)}this.shape=t}moveUp(){this.position={...this.position,y:this.position.y+-1}}moveDown(){this.position={...this.position,y:this.position.y+1}}moveRight(){this.position={...this.position,x:this.position.x+1}}moveLeft(){this.position={...this.position,x:this.position.x-1}}print(){console.log(this)}getHeight(){return this.shape.length}getWidth(){return this.shape[0].length}}class I{static getNewBlock(){const t=Math.floor(Math.random()*14);return t<2?this.getOBlock():t<4?this.getLBlock():t<6?this.getJBlock():t<8?this.getTBlock():t<10?this.getZBlock():t<12?this.getSBlock():this.getIBlock()}static getSBlock(){const t=this.getRandomColor();return new d([[0,t,t],[t,t,0],[0,0,0]],{x:m,y:u})}static getZBlock(){const t=this.getRandomColor();return new d([[t,t,0],[0,t,t],[0,0,0]],{x:m,y:u})}static getTBlock(){const t=this.getRandomColor();return new d([[0,t,0],[t,t,t],[0,0,0]],{x:m,y:u})}static getLBlock(){const t=this.getRandomColor();return new d([[0,0,t],[t,t,t],[0,0,0]],{x:m,y:u})}static getJBlock(){const t=this.getRandomColor();return new d([[t,0,0],[t,t,t],[0,0,0]],{x:m,y:u})}static getOBlock(){const t=this.getRandomColor();return new d([[t,t],[t,t]],{x:m,y:u})}static getIBlock(){const t=this.getRandomColor();return new d([[0,0,0,0],[0,0,0,0],[t,t,t,t],[0,0,0,0]],{x:m,y:u})}static getRandomColor(){return Math.floor(Math.random()*5+1)}}class L{constructor(){n(this,"startTime",null);n(this,"drawTimeInterval")}start(){this.startTime=Date.now(),this.drawTime()}clearDrawTimeInterval(){clearInterval(this.drawTimeInterval)}getTime(){if(!this.startTime)return;const t=Date.now()-this.startTime,e=Math.floor(t/6e4),s=Math.floor(t%6e4/1e3),i=String(e).padStart(2,"0"),o=String(s).padStart(2,"0");return`${i}:${o}`}drawTime(){this.drawTimeInterval=setInterval(()=>{const t=this.getTime();t&&a.writeTime(t)},1e3)}}class a{static draw(t){this.clearView(),this.colorView(t)}static colorView(t){const e=document.getElementsByClassName("cell");for(let s=0;s<t.grid.length;s++)for(let i=0;i<t.grid[0].length;i++){const o=e[t.grid[0].length*s+i];switch(t.grid[s][i]){case 0:continue;case 1:o.classList.add("red");break;case 2:o.classList.add("orange");break;case 3:o.classList.add("yellow");break;case 4:o.classList.add("green");break;case 5:o.classList.add("blue");break}}}static clearView(){document.getElementById("gameGUI").querySelectorAll(".cell").forEach(s=>{["red","orange","yellow","green","blue"].forEach(i=>{s.classList.remove(i)})})}static writeTime(t){const e=document.getElementById("time");e&&(e.innerText=t)}static writeRound(t){const e=document.getElementById("round");e&&(e.innerText=t+"")}static writeScore(t){const e=document.getElementById("score");e&&(e.innerText=t+"")}static drawPreview(t){const e=document.getElementById("preview");if(!e)return;e.innerHTML="";const s=t.shape.length,i=t.shape[0].length;i===4&&(e.style.display="grid",e.style.width=`${32*4}px`,e.style.gridTemplateColumns="repeat(4, 1fr)"),i===3&&(e.style.display="grid",e.style.width=`${32*3}px`,e.style.gridTemplateColumns="repeat(3, 1fr)"),i===2&&(e.style.display="grid",e.style.width=`${32*2}px`,e.style.gridTemplateColumns="repeat(2, 1fr)");for(let o=0;o<s;o++)for(let h=0;h<i;h++){const g=document.createElement("div");switch(g.classList.add("cell"),t.shape[o][h]){case 0:break;case 1:g.classList.add("red");break;case 2:g.classList.add("orange");break;case 3:g.classList.add("yellow");break;case 4:g.classList.add("green");break;case 5:g.classList.add("blue")}e.appendChild(g)}}}function R(){const r=document.getElementById("gameGUI"),t=document.createElement("button"),e=new f,s=()=>{const i=document.getElementById("startBtn");i.style.visibility="hidden",e.start()};t.id="startBtn",t.innerText="start",t.classList.add("button"),t.addEventListener("click",s),r.appendChild(t)}const x=()=>{const r=document.getElementById("restartBtn");if(!r)return;r.style.visibility="hidden",new f().start()};function S(){const r=document.getElementById("gameGUI"),t=document.createElement("button");t.id="restartBtn",t.innerText="again?",t.classList.add("button"),t.addEventListener("click",x),r==null||r.appendChild(t)}function E(r,t){const e=document.getElementById("gameGUI"),s=document.createElement("div");s.id="roundPopup",t&&t>1?s.innerHTML=`<span>round ${r}</span><span class="rainbow-text">${t}up!</span>`:s.innerHTML=`<span>round ${r}</span>`,s.classList.add("popup"),e==null||e.appendChild(s)}function O(){var t;const r=document.getElementById("roundPopup");r&&((t=r.parentElement)==null||t.removeChild(r))}y(100);C();R();
